<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Webhook Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            background: #111;
            color: #eee;
            font-family: sans-serif;
            margin: 20px;
        }
        h2 {
            text-align: center;
        }
        .select-wrapper {
            text-align: center;
            margin-bottom: 20px;
        }
        table {
            border-collapse: collapse;
            margin: 0 auto;
            width: 95%;
        }
        th, td {
            border: 1px solid #444;
            padding: 6px;
            text-align: center;
        }
        th {
            background-color: #222;
        }
        td.low { background-color: #1e3a5f; }
        td.medium { background-color: #3b82f6; }
        td.high { background-color: #60a5fa; }
        td.veryhigh { background-color: #93c5fd; }
        canvas {
            margin-top: 30px;
        }
    </style>
</head>
<body>
    <h2>Webhook-Alarm Dashboard</h2>

    <div class="select-wrapper">
        <label for="yearSelect">Jahr ausw√§hlen:</label>
        <select id="yearSelect" onchange="filterByYear()">
            <option value="all">Alle Jahre</option>
            {% for jahr in jahre %}
            <option value="{{ jahr }}">{{ jahr }}</option>
            {% endfor %}
        </select>
    </div>

    <div id="heatmap-container">
        {{ heatmap_table|safe }}
    </div>

    <canvas id="lineChart" width="900" height="400"></canvas>

    <script>
        const yearSelect = document.getElementById("yearSelect");
        const fullTableHTML = document.getElementById("heatmap-container").innerHTML;

        function filterByYear() {
            const year = yearSelect.value;
            const rows = document.querySelectorAll("tbody tr");
            const headerCells = document.querySelectorAll("thead th");
            headerCells.forEach((th, i) => {
                if (i === 0) return;
                const colYear = th.innerText.split("-")[0];
                th.style.display = (year === "all" || year === colYear) ? "" : "none";
                rows.forEach(row => {
                    const td = row.children[i];
                    if (td) td.style.display = (year === "all" || year === colYear) ? "" : "none";
                });
            });
        }

        const chartData = {{ chart_data | safe }};
        const ctx = document.getElementById('lineChart').getContext('2d');
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: chartData.labels,
                datasets: chartData.datasets
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'bottom'
                    },
                    title: {
                        display: true,
                        text: 'Alarm-Verlauf pro Symbol'
                    }
                },
                interaction: {
                    mode: 'index',
                    intersect: false
                },
                scales: {
                    x: { display: true, title: { display: true, text: 'Monat' }},
                    y: { display: true, title: { display: true, text: 'Anzahl Alarme' }}
                }
            }
        });
    </script>
</body>
</html>
