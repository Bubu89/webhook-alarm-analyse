<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Webhook-Alarm Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #111;
            color: #fff;
            padding: 20px;
        }
        h2 {
            margin-top: 40px;
        }
        select {
            font-size: 16px;
            margin-bottom: 10px;
        }
        table {
            border-collapse: collapse;
            margin: 0 auto;
            width: 95%;
        }
        th, td {
            border: 1px solid #444;
            padding: 6px;
            text-align: center;
        }
        th {
            background-color: #222;
        }
        td.low { background-color: #1e3a5f; }
        td.medium { background-color: #3b82f6; }
        td.high { background-color: #60a5fa; }
        td.veryhigh { background-color: #93c5fd; }

        .section {
            margin-top: 60px;
        }
        .log-table {
            width: 80%;
            margin: 0 auto;
        }
    </style>
</head>
<body>

    <h1>Webhook-Alarm Dashboard</h1>

    <!-- Jahresfilter -->
    <div style="text-align: center;">
        <label for="yearSelect">Jahr ausw√§hlen:</label>
        <select id="yearSelect" onchange="filterByYear()">
            {% for jahr in jahre %}
                <option value="{{ jahr }}">{{ jahr }}</option>
            {% endfor %}
        </select>
    </div>

    <!-- Heatmap -->
    <div class="section">
        <h2>Alarm Heatmap (12 Monate)</h2>
        <table id="heatmapTable">
            <thead>
                <tr>
                    <th>Symbol</th>
                    {% for monat in matrix.values()|first %}
                        <th class="monat-column">{{ monat }}</th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                {% for symbol, monatsdaten in matrix.items() %}
                    <tr>
                        <td>{{ symbol }}</td>
                        {% for monat, count in monatsdaten.items() %}
                            {% set klasse = "low" %}
                            {% if count > 5 %} {% set klasse = "medium" %} {% endif %}
                            {% if count > 15 %} {% set klasse = "high" %} {% endif %}
                            {% if count > 30 %} {% set klasse = "veryhigh" %} {% endif %}
                            <td class="{{ klasse }} monat-column" data-monat="{{ monat }}">{{ count }}</td>
                        {% endfor %}
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Chart -->
    <div class="section">
        <h2>Alarme im Zeitverlauf (Liniendiagramm)</h2>
        <canvas id="lineChart" height="120"></canvas>
        <script>
            const chartLabels = {{ monate_js|safe }};
            const chartData = {{ chart_daten_js|safe }};
            const colors = ['#60a5fa', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#14b8a6'];

            const datasets = Object.keys(chartData).map((symbol, index) => ({
                label: symbol,
                data: chartData[symbol],
                borderColor: colors[index % colors.length],
                fill: false
            }));

            new Chart(document.getElementById('lineChart').getContext('2d'), {
                type: 'line',
                data: {
                    labels: chartLabels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'top' }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });

            function filterByYear() {
                const jahr = document.getElementById("yearSelect").value;
                document.querySelectorAll(".monat-column").forEach(td => {
                    td.style.display = td.innerText.startsWith(jahr + "-") ? "" : "none";
                });
            }
        </script>
    </div>

    <!-- Letzte Alarme -->
    <div class="section">
        <h2>Letzte 10 empfangene Alarme</h2>
        <table class="log-table">
            <thead>
                <tr><th>Timestamp</th><th>Symbol</th><th>Weitere Daten</th></tr>
            </thead>
            <tbody>
                {% for eintrag in letzte_alarme %}
                    <tr>
                        <td>{{ eintrag.timestamp }}</td>
                        <td>{{ eintrag.symbol }}</td>
                        <td>{{ eintrag.extra }}</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Intervall-Erkennung -->
    <div class="section">
        <h2>Per E-Mail gesendete Alarmsignale (erkanntes Intervall)</h2>
        <table class="log-table">
            <thead>
                <tr><th>Symbol</th><th>Anzahl Alarme</th><th>Zeitraum (Min)</th><th>Versendet am</th></tr>
            </thead>
            <tbody>
                {% for alarm in erkannte_intervalle %}
                    <tr>
                        <td>{{ alarm.symbol }}</td>
                        <td>{{ alarm.count }}</td>
                        <td>{{ alarm.zeitraum }}</td>
                        <td>{{ alarm.zeitpunkt }}</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

</body>
</html>
